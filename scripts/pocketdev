#!/bin/bash
#
# PocketDev Self-Management Script
# Run from inside the pocket-dev-php container to manage the container itself
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if HOST_PROJECT_PATH is set
if [ -z "$HOST_PROJECT_PATH" ]; then
    echo -e "${RED}Error: HOST_PROJECT_PATH environment variable is not set.${NC}"
    echo ""
    echo "Add this to your .env file:"
    echo "  HOST_PROJECT_PATH=/path/to/pocket-dev"
    echo ""
    echo "Then restart the container with: docker compose up -d"
    exit 1
fi

# Function to run docker compose via helper container
run_compose() {
    local cmd="$1"
    echo -e "${YELLOW}Running: docker compose $cmd${NC}"

    docker run --rm -d \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v "${HOST_PROJECT_PATH}:${HOST_PROJECT_PATH}" \
        -w "${HOST_PROJECT_PATH}" \
        docker:cli \
        docker compose -p pocket-dev $cmd

    echo -e "${GREEN}Command triggered in background.${NC}"
    echo "The container will restart - you may lose this terminal session."
}

# Show help
show_help() {
    echo "PocketDev Self-Management Script"
    echo ""
    echo "Usage: pocketdev <command>"
    echo ""
    echo "Commands:"
    echo "  restart     Restart PHP container (for entrypoint/config changes)"
    echo "  rebuild     Rebuild and restart PHP container (for Dockerfile changes)"
    echo "  rebuild-all Rebuild and restart all containers"
    echo "  frontend    Rebuild frontend assets (npm run build)"
    echo "  status      Show container status"
    echo "  logs        Show PHP container logs"
    echo "  help        Show this help message"
    echo ""
    echo "Most code changes (PHP, Blade, JS) don't require restart."
    echo "Use 'restart' for entrypoint.sh or config changes."
    echo "Use 'rebuild' for Dockerfile changes."
}

case "${1:-help}" in
    restart)
        echo -e "${YELLOW}Restarting PHP and Nginx containers...${NC}"
        run_compose "up -d --force-recreate pocket-dev-php pocket-dev-nginx"
        ;;

    rebuild)
        echo -e "${YELLOW}Rebuilding PHP container (this may take a minute)...${NC}"
        run_compose "up -d --build --force-recreate pocket-dev-php pocket-dev-nginx pocket-dev-queue"
        ;;

    rebuild-all)
        echo -e "${YELLOW}Rebuilding all containers...${NC}"
        run_compose "up -d --build --force-recreate"
        ;;

    frontend)
        echo -e "${YELLOW}Rebuilding frontend assets...${NC}"
        cd /var/www
        npm run build
        echo -e "${GREEN}Frontend assets rebuilt successfully.${NC}"
        ;;

    status)
        docker ps --filter "name=pocket-dev" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        ;;

    logs)
        docker logs pocket-dev-php --tail 50 -f
        ;;

    help|--help|-h)
        show_help
        ;;

    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
