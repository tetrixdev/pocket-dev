# Claude CLI Integration

PocketDev wraps Claude Code CLI (`@anthropic-ai/claude-code`) to provide a web interface.

## Service

**File:** `app/Services/ClaudeCodeService.php`

## Configuration

**File:** `config/claude.php`

```php
return [
    'binary_path' => env('CLAUDE_BINARY_PATH', 'claude'),
    'timeout' => env('CLAUDE_TIMEOUT', 300),
    'model' => env('CLAUDE_MODEL', 'claude-sonnet-4-5-20250929'),
    'max_turns' => env('CLAUDE_MAX_TURNS', 100),
];
```

## CLI Commands Used

### Basic Query

```bash
claude --print --output-format json "prompt here"
```

**Flags:**
- `--print`: Output to stdout (not interactive mode)
- `--output-format json`: Return structured JSON

### Streaming Query

```bash
claude --print --output-format stream-json "prompt here"
```

**Output:** JSON lines (one JSON object per line)

### With Session

```bash
claude --print --output-format stream-json \
       --session <uuid> \
       --resume \
       "prompt here"
```

**Flags:**
- `--session <uuid>`: Use specific session ID
- `--resume`: Continue from last state in session

### With Thinking

```bash
claude --print --output-format stream-json \
       --thinking-budget <level> \
       "prompt here"
```

**Levels:** `none`, `low`, `high`

### With Working Directory

```bash
cd /workspace/project && claude --print ...
```

The service changes directory before execution.

## Service Methods

### `isAvailable(): bool`

Checks if Claude CLI is installed and credentials exist.

```php
public function isAvailable(): bool
{
    // Check binary exists
    $process = Process::run([$this->binaryPath, '--version']);
    if (!$process->successful()) {
        return false;
    }

    // Check credentials exist
    return file_exists($this->credentialsPath);
}
```

### `query(string $prompt, ?string $sessionId, array $options): array`

Synchronous query, returns full response.

```php
public function query(string $prompt, ?string $sessionId = null, array $options = []): array
{
    $command = $this->buildCommand($prompt, $sessionId, $options);
    $process = Process::run($command);

    if (!$process->successful()) {
        throw new ClaudeCodeException($process->errorOutput());
    }

    return json_decode($process->output(), true);
}
```

### `streamQuery(string $prompt, ?string $sessionId, Closure $onChunk, ...): void`

Streaming query with callback for each chunk.

```php
public function streamQuery(
    string $prompt,
    ?string $sessionId,
    Closure $onChunk,
    ?string $workingDirectory = null,
    string $thinkingLevel = 'none'
): void {
    $command = $this->buildStreamCommand($prompt, $sessionId, $thinkingLevel);

    $descriptorspec = [
        0 => ['pipe', 'r'],  // stdin
        1 => ['pipe', 'w'],  // stdout
        2 => ['pipe', 'w'],  // stderr
    ];

    $process = proc_open(
        $command,
        $descriptorspec,
        $pipes,
        $workingDirectory ?? getcwd()
    );

    // Write prompt to stdin
    fwrite($pipes[0], $prompt);
    fclose($pipes[0]);

    // Read stdout line by line
    while (!feof($pipes[1])) {
        $line = fgets($pipes[1]);
        if ($line !== false && trim($line) !== '') {
            $chunk = json_decode($line, true);
            if ($chunk) {
                $onChunk($chunk);
            }
        }
    }

    fclose($pipes[1]);
    fclose($pipes[2]);
    proc_close($process);
}
```

## Session Management

### Session Files

Claude CLI stores sessions in `.jsonl` files:

```
~/.claude/projects/<project-hash>/<session-uuid>.jsonl
```

Each line is a JSON object representing a message or metadata.

### Session UUID

Generated by Claude CLI when creating a new session. PocketDev stores this UUID in `claude_sessions.claude_session_id`.

### Resuming Sessions

To continue a session:
1. Pass `--session <uuid>` to use specific session
2. Pass `--resume` to continue from last state

## Response Structure

### Non-Streaming (JSON)

```json
{
    "type": "result",
    "subtype": "success",
    "is_error": false,
    "result": "The actual response text",
    "session_id": "uuid-here"
}
```

### Streaming (stream-json)

Multiple JSON lines:

```json
{"type":"stream_event","event":{"type":"content_block_start",...}}
{"type":"stream_event","event":{"type":"content_block_delta",...}}
{"type":"stream_event","event":{"type":"message_delta","usage":{...}}}
```

See `modules/chat/streaming.md` for detailed event handling.

## Credentials

### Location

```
/var/www/.claude/.credentials.json
```

Owned by `www-data:www-data` (PHP-FPM user).

### Structure

```json
{
    "claudeAiOauth": {
        "accessToken": "...",
        "refreshToken": "...",
        "expiresAt": 1234567890
    }
}
```

### Authentication Methods

1. **Web UI** (`/claude/auth`): Upload file or paste JSON
2. **Docker exec**: `docker exec -it pocket-dev-php claude setup-token`

## Error Handling

### ClaudeCodeException

Custom exception for CLI errors:

```php
namespace App\Exceptions\ClaudeCode;

class ClaudeCodeException extends \Exception
{
    // Standard exception with message
}
```

Thrown when:
- CLI not found
- Credentials missing
- CLI returns non-zero exit code
- Malformed JSON response

### Common Errors

| Error | Cause | Solution |
|-------|-------|----------|
| "claude: command not found" | CLI not installed | Run `npm i -g @anthropic-ai/claude-code` in container |
| "Credentials not found" | No `.credentials.json` | Authenticate via `/claude/auth` |
| "Session not found" | Invalid session UUID | Create new session |
| "Rate limited" | Too many requests | Wait and retry |

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `CLAUDE_BINARY_PATH` | `claude` | Path to CLI binary |
| `CLAUDE_TIMEOUT` | `300` | Command timeout (seconds) |
| `CLAUDE_MODEL` | `claude-sonnet-4-5-20250929` | Default model |
| `CLAUDE_MAX_TURNS` | `100` | Max conversation turns |

## Debugging

### Test CLI Directly

```bash
docker exec pocket-dev-php claude --version
docker exec pocket-dev-php claude --print "Hello"
```

### Check Credentials

```bash
docker exec pocket-dev-php cat /var/www/.claude/.credentials.json
```

### View CLI Output

Add logging in ClaudeCodeService:

```php
Log::debug('Claude command', ['command' => implode(' ', $command)]);
Log::debug('Claude response', ['output' => $process->output()]);
```
